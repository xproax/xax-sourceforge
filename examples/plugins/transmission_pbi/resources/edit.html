
<form data-dojo-type="dijit.form.Form">

<script type="dojo/method">
    var plugin_name = "transmission";
    var service = new dojo.rpc.JsonService({
        serviceUrl: "/plugins/json/",
    });

    var plugin_info = null;
    var mounted = null;
    var saved = null;
    var arch = null;

    sd = function(k, v) {
        if (!saved[k]) {
            saved[k] = v;
        }
    }

    set_defaults = function() {
        sd("transmission_conf_dir", "/usr/pbi/transmission-" + arch + "/etc/transmission/home");
        sd("transmission_download_dir", "/usr/pbi/transmission-" + arch + "/etc/transmission/home/Downloads");
    }

    get_saved = function() {
        var saved = null;
     
        dojo.xhrGet({
            url: '/plugins/transmission/2.42/saved',
            sync: true,
            failOk: true,
            handleAs: "json",  
            handle: function(data) {
                saved = data;
            },
        });
            
        return saved;
    }

    filldiv = function(divid, header, settings) {
        var div = dojo.byId(divid);
        var table = dojo.create("table", {align: "center"}, div);
        var tr = dojo.create("tr", null, table);
        var th = dojo.create("th", {colspan: "2", align: "center"}, table);
        
        var s = dojo.create("strong", {innerHTML: header}, th);
        for (var i = 0;i < settings.length;i++) {
            var tr = dojo.create("tr", null, table);
            var td1 = dojo.create("td", {innerHTML: settings[i].label}, tr);
            var td2 = dojo.create("td", null, tr);
            var obj = settings[i].type.placeAt(td2);
        }
    }

    get_directories = function() {
        var mp_list = new Array();
        if (mounted && mounted.length) {
            for (var i = 0;i < mounted.length;i++) {
                mp_list[i] = mounted[i][1];
            }
        }

        dirs = new Array(mp_list.length + 3)
        dirs[0] = "-";
        dirs[1] = "/usr/pbi/transmission-" + arch + "/etc/transmission/home";
        dirs[2] = "/usr/pbi/transmission-" + arch + "/etc/transmission/home/Downloads";
        for (var i = 0;i < mp_list.length;i++) {   
            dirs[i + 3] = mp_list[i];
        }
            
        return dirs;
    }

    var saved = get_saved();

    transmission_daemon_config = function() {
        var dirs = get_directories();
        var sel_watch_dir = new Array(dirs.length);
        var sel_conf_dir = new Array(dirs.length);
        var sel_download_dir = new Array(dirs.length);

        for (var i = 0;i < dirs.length;i++) {
            var s = false;

            s = (dirs[i] == saved["transmission_watch_dir"]);
            sel_watch_dir[i] = {
                label: dirs[i],
                value: dirs[i],
                selected: s
            };

            s = (dirs[i] == saved["transmission_conf_dir"]);
            sel_conf_dir[i] = {
                label: dirs[i],
                value: dirs[i],
                selected: s
            };

            s = (dirs[i] == saved["transmission_download_dir"]);
            sel_download_dir[i] = {
                label: dirs[i],
                value: dirs[i],
                selected: s
            };
        }

        var daemon_settings = new Array(
            {
                label: "Enable",
                type: new dijit.form.CheckBox({
                    name: "transmission_enable",
                    checked: saved["transmission_enable"]
                })
            },
            {
                label: "Watch Directory",
                type: new dijit.form.Select({
                    name: "transmission_watch_dir",
                    options: sel_watch_dir 
                })
            },
            {
                label: "Configuration Directory",
                type: new dijit.form.Select({
                    name: "transmission_conf_dir",
                    options: sel_conf_dir 
                })
            },
            {
                label: "Download Directory",
                type: new dijit.form.Select({
                    name: "transmission_download_dir",
                    options: sel_download_dir 
                })
            }
        );

        filldiv("transmission_daemon_config", "Daemon Configuration", daemon_settings);
    }

    transmission_advanced_show = true;
    transmission_advanced_config = function() {
        var avsettings = new Array(
            { 
                label: "Allowed IP addresses",
                type: new dijit.form.TextBox({
                    name: "transmission_allowed",
                    value: saved["transmission_allowed"]
                })
            },
            { 
                label: "Blocklist",
                type: new dijit.form.CheckBox({
                    name: "transmission_blocklist",
                    checked: saved["transmission_blocklist"]
                })
            },
            { 
                label: "Logfile",
                type: new dijit.form.TextBox({
                    name: "transmission_logfile",
                    value: saved["transmission_logfile"]
                })
            },
            { 
                label: "Port",
                type: new dijit.form.TextBox({
                    name: "transmission_port",
                    value: saved["transmission_port"]
                })
            },
            { 
                label: "Authentication",
                type: new dijit.form.CheckBox({
                    name: "transmission_auth",
                    checked: saved["transmission_auth"]
                })
            },
            { 
                label: "Username",
                type: new dijit.form.TextBox({
                    name: "transmission_username",
                    value: saved["transmission_username"]
                })
            },
            { 
                label: "Password",
                type: new dijit.form.TextBox({
                    name: "transmission_password",
                    value: saved["transmission_password"]
                })
            },
            { 
                label: "Distributed hash tables",
                type: new dijit.form.CheckBox({
                    name: "transmission_dht",
                    checked: saved["transmission_dht"]
                })
            },
            { 
                Label: "Local peer discovery",
                type: new dijit.form.CheckBox({
                    name: "transmission_lpd",
                    checked: saved["transmission_lpd"]
                })
            },
            { 
                label: "uTP",
                type: new dijit.form.CheckBox({
                    name: "transmission_utp",
                    checked: saved["transmission_utp"]
                })
            },
            { 
                label: "Peer port",
                type: new dijit.form.TextBox({
                    name: "transmission_peerport",
                    value: saved["transmission_peerport"]
                })
            },
            { 
                label: "Portmapping",
                type: new dijit.form.CheckBox({
                    name: "transmission_portmap",
                    checked: saved["transmission_portmap"]
                })
            },
            { 
                label: "Global peer limit",
                type: new dijit.form.TextBox({
                    name: "transmission_peerlimit_global",
                    value: saved["transmission_peerlimit_global"]
                })
            },
            { 
                label: "Torrent peer limit",
                type: new dijit.form.TextBox({
                    name: "transmission_peerlimit_torrent",
                    value: saved["transmission_peerlimit_torrent"]
                })
            },
            { 
                label: "Encrypt all peer connections",
                type: new dijit.form.CheckBox({
                    name: "transmission_encryption_required",
                    checked: saved["transmission_encryption_required"]
                })
            },
            { 
                label: "Prefer encrypted peer connections",
                type: new dijit.form.CheckBox({
                    name: "transmission_encryption_preferred",
                    checked: saved["transmission_encryption_preferred"]
                })
            },
            { 
                label: "Prefer unencrypted peer connections",
                type: new dijit.form.CheckBox({
                    name: "transmission_encryption_tolerated",
                    checked: saved["transmission_encryption_tolerated"]
                })
            },
            { 
                label: "Global seed ratio",
                type: new dijit.form.TextBox({
                    name: "transmission_global_seedration",
                    value: saved["transmission_global_seedration"]
                })
            }
        );

	if (transmission_advanced_show == true) {
            filldiv("transmission_advanced_settings", "Advanced Settings", avsettings);
            transmission_advanced_show = false;

	} else {
       	    var avs = dojo.byId("transmission_advanced_settings");
            avs.innerHTML = null;
            transmission_advanced_show = true;
	}
    }

    wait_for_mounted = function() {
        plugin_info = dojo.fromJson(plugin_info);

        var fields = plugin_info[0]["fields"];
        var plugin_path = fields["plugin_path"];

        var s = service.callRemote("fs.mounted.get", [plugin_path]);
        s.addCallback(function(result) {
            mounted = result;

            get_saved();
            set_defaults();
            transmission_daemon_config(); 
        });
    }

    wait_for_plugin_info = function() {
        var s = service.callRemote("plugins.plugins.get", [plugin_name]);
        s.addCallback(function(result) {
            plugin_info = result;

            wait_for_mounted();
        });
    }

    wait_for_arch = function() {
        var s = service.callRemote("os.arch");
        s.addCallback(function(result) {
            arch = result;

            wait_for_plugin_info();
        });
    }
     
    main = function() {
        wait_for_arch(); 
    }

    main();

</script>

    <script type="dojo/event" data-dojo-event="onSubmit" data-dojo-args="e">
        formSubmit(this, e, "/plugins/transmission/2.42/post");
    </script>

<div id="transmission_daemon_config"></div>

<table>
    <tr>
        <td>Advanced Settings</td>
        <td>
            <button data-dojo-type="dijit.form.CheckBox" type="button">
                <script type="dojo/method" data-dojo-event="onClick" data-dojo-args="evt">
                    transmission_advanced_config();
                </script>
            </button>
        </td>
    </tr>
</table>

<div id="transmission_advanced_settings"></div>

<table align="center">

    <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
    </tr>

    <tr>
        <td colspan="2" align="center">
            <button data-dojo-type="dijit.form.Button" type="submit"
                data-dojo-props="type:'submit'" class="submitform">
                OK
            </button>
            <button data-dojo-type="dijit.form.Button" type="button">
                Cancel
                <script type="dojo/method" data-dojo-event="onClick" data-dojo-args="evt">
                    cancelDialog(this);
                </script>
            </button>
        </td>
    </tr>

</table>
</form>
