<form data-dojo-type="dijit.form.Form">

<script type="dojo/method">
    var plugin_name = "transmission";
    var service = new dojo.rpc.JsonService({
        serviceUrl: "/plugins/json/",
    });

    var nmp = 0;
    var plugin_info = null;
    var mountpoints = null;
    var mounted = null;


    filldiv = function(divid, header, settings) {
        var div = dojo.byId(divid);
        var table = dojo.create("table", {align: "center"}, div);

        if (header) {
            var tr = dojo.create("tr", null, table);
            var th = dojo.create("th", {colspan: "2", align: "center"}, table);
            var s = dojo.create("strong", {innerHTML: header}, th);
        }

        for (var i = 0;i < settings.length;i++) {
            var tr = dojo.create("tr", null, table);

            var td1 = dojo.create("td", null, tr);
            var obj = settings[i].src.placeAt(td1);

            var td2 = dojo.create("td", null, tr);
            var obj = settings[i].dst.placeAt(td2);
            
            var td3 = dojo.create("td", null, tr);
            var obj = settings[i].mount.placeAt(td3);

            var td4 = dojo.create("td", null, tr);
            var obj = settings[i].umount.placeAt(td4);
        }
    }

    rpc_do_mount = function(args) {
        var rpc_args = new Array();
        rpc_args[0] = args["src"].value;
        rpc_args[1] = args["dst"].value;

        service.callRemote("fs.mount", rpc_args).addCallback(
            function(result) { console.log(result); });
    }

    rpc_do_umount = function(args) {
        var rpc_args = new Array();
        rpc_args[0] = args["dst"].value;

        service.callRemote("fs.umount", rpc_args).addCallback(
            function(result) { console.log(result); });
    }

    make_sel_mp_list = function(path) {
        var sel_mp_list = new Array(); 

        for (var i = 0;i < mountpoints.length;i++) {
            var s = false;

            if (path != null) {
                s = (mountpoints[i] == path);
            }

            sel_mp_list[i] = {
                label: mountpoints[i],
                value: mountpoints[i],
                selected: s
            };
        }

        return sel_mp_list;
    }

    make_mp = function(n, sel_mp_list) {
        var value = null;
        if (mounted && mounted[n]) {
            value = mounted[n][1]
        }

        var mp = {
            src: new dijit.form.Select({
                id: "mp_src_" + n,
                options: sel_mp_list
            }),
            dst: new dijit.form.TextBox({
                id: "mp_dst_" + n,
                value: value
            }),
            mount: new dijit.form.Button({
                label: "mount",
                id: "mount_" + n + "_button",
                onClick: function() {
                    rpc_do_mount({
                        src: mp["src"],
                        dst: mp["dst"]
                    });
                }
            }),
            umount: new dijit.form.Button({
                label: "umount",
                id: "umount_" + n + "_button",
                onClick: function() {
                    rpc_do_umount({
                        dst: mp["dst"]
                    });
                }
            })
        }

        return mp;
    }

    mp_add = function() {
        var mountpoint_settings = new Array();
        if (nmp <= 0) {

            for (var i = 0;i < mounted.length;i++) {
                var sel_mp_list = make_sel_mp_list(mounted[i][0]); 
                mountpoint_settings[i] = make_mp(i, sel_mp_list);
                nmp++;
            }

            filldiv("mp_add", "Mount Point Configuration", mountpoint_settings);

        } else {
            var sel_mp_list = make_sel_mp_list();

            mountpoint_settings[0] = make_mp(nmp, sel_mp_list);
            nmp++;
             
            filldiv("mp_add", null, mountpoint_settings);
        }
    }

    wait_for_mountpoints = function() {
        var s = service.callRemote("fs.mountpoints.get");
        s.addCallback(function(result) {
            mountpoints = result;

            mp_add();
        });

    }

    wait_for_mounted = function() {
        plugin_info = dojo.fromJson(plugin_info);

        var fields = plugin_info[0]["fields"];
        var plugin_path = fields["plugin_path"];

        var s = service.callRemote("fs.mounted.get", [plugin_path]);
        s.addCallback(function(result) {
            mounted = result;

            wait_for_mountpoints();
        });
    }

    wait_for_plugin_info = function() {
        var s = service.callRemote("plugins.plugins.get", [plugin_name]);
        s.addCallback(function(result) {
            plugin_info = result;

            wait_for_mounted();
        });
    }

    main = function() {
        wait_for_plugin_info(); 
    }

    main();

</script>

<script type="dojo/event" data-dojo-event="onSubmit" data-dojo-args="e">
    cancelDialog(this);
</script>

<div id="mp_add"></div>

<table align="center">

    <tr>
        <td colspan="2" align="center">
            <button data-dojo-type="dijit.form.Button" type="button" id="button_mp_add">
                Add Mount Point
                <script type="dojo/method" data-dojo-event="onClick" data-dojo-args="evt">
                    mp_add();
                </script>
            </button>
        </td>
    </tr>

    <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
    </tr>

    <tr>
        <td colspan="2" align="center">
            <button data-dojo-type="dijit.form.Button" type="submit"
                data-dojo-props="type:'submit'" class="submitform">
                OK
            </button>
            <button data-dojo-type="dijit.form.Button" type="button">
                Cancel
                <script type="dojo/method" data-dojo-event="onClick" data-dojo-args="evt">
                    cancelDialog(this);
                </script>
            </button>
        </td>
    </tr>

</table>
</form>
