<div data-dojo-type="dijit.layout.BorderContainer" style="width:100%;height:100%" data-dojo-props="gutters: false, toggleSplitterOpen: true">
  <div class="gridDiv" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region: 'center'"></div>
  <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region: 'bottom', splitter: false" style="border: 1px solid #ddd;background-color: white;height: 50px;" doLayout="false">
    <div data-dojo-type="dijit.layout.BorderContainer" style="width:100%;height:100%" data-dojo-props="gutters: false, toggleSplitterOpen: true">
      {% block actions_static_pane %}
      <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region: 'left', splitter: false" style="background-color: white;width: 150px;" doLayout="false">
        {% block actions_static_buttons %}
        <div class="gridAdd left">
          <button data-dojo-type="dijit.form.Button" type="button">
              {% blocktrans with name=verbose_name %}Add {{ name }}{% endblocktrans %}
          <script type="dojo/method" event="onClick" args="evt">
              editObject('{% trans "Add"|escapejs %}', '{{ add_url }}', [this,]);
          </script>
          </button>
        </div>
        {% endblock %}
        <span class="clear"></span>
      </div>
      {% endblock %}

      <div class="actionsPane" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region: 'center', splitter: false" style="background-color: white;" doLayout="false">
        {% block actions_pane %}
        {% endblock %}
        <span class="clear"></span>
      </div>
    </div>
  </div>
</div>
<div data-dojo-type="dijit.layout.ContentPane">
    <script type="dojo/method">
    var cpane = this;
require([
    "dojo/dom",
    "dojo/dom-class",
    "dojo/dom-construct",
    "dojo/dom-style",
    "dojo/query",
    "dojo/request/xhr",
    "dojo/store/JsonRest",
    "dgrid/OnDemandGrid",
    "dgrid/Keyboard",
    "dgrid/Selection",
    "dgrid/tree",
    "dojo/_base/declare",
    "dgrid/extensions/DijitRegistry",
    "dijit/registry",
    "dijit/form/Button"
    ], function(
    dom,
    domClass,
    domConstruct,
    domStyle,
    query,
    xhr,
    JsonRest,
    Grid,
    Keyboard,
    Selection,
    tree,
    declare,
    DijitRegistry,
    registry,
    Button) {

    var columns, actions;
    xhr.get('{{ structure_url }}', {
        sync: true,
        handleAs: 'text'
    }).then(function(data) {
        columns = eval('(' + data + ')');
        for(var key in columns) {
            if(typeof columns[key] == 'string') {
                columns[key] = eval('(' + columns[key] + ')')
            }
            if(columns[key].shouldExpand !== undefined){
		columns[key].shouldExpand = function() { return true };
	    }
        }
    });

    xhr.get('{{ actions_url }}', {
        sync: true,
        handleAs: 'json'
    }).then(function(data) {
        actions = data;
        for(var key in actions) {
            for(var func in {'on_select': 1, 'on_click': 1}) {
              var funceval = eval('(' + actions[key][func] + ')');
              actions[key][func] = funceval;
            }

            var pane = query(".actionsPane", cpane.domNode.parentNode)[0];

            var n = domConstruct.create("div", null, pane);
            domClass.add(n, ["grid" + key, "left"]);

            var but = new Button({
                'label': actions[key]['button_name'],
                'onClick': actions[key]['on_click']
            });
            but.placeAt(n);

        }
    });

    var store = new JsonRest({
        target: "{% url api_dispatch_list api_name="v1.0" resource_name=resource_name %}",
        getChildren: function(parent, options){
            return parent.children;
        },
        mayHaveChildren: function(parent){
            return parent.children !== undefined && parent.children.length > 0;
        }
    });

    var StandardGrid = declare([Grid, Selection, Keyboard]);
    var griddiv = query(".gridDiv:first-child", cpane.domNode.parentNode)[0];
    grid = new StandardGrid({
        id: 'orderGrid',
        store: store,
        columns: columns,
        }, griddiv);

    grid.on(".dgrid-row:dblclick", function(evt) {
        var row = grid.row(evt);
        editObject('{% trans "Edit"|escapejs %}', row.data._edit_url, [this, ]);
    });

    var selectionCheck = function(numrows) {
        for(key in actions) {
            var func = actions[key]['on_select'];
            try {
              func(numrows);
            } catch(e) {
              console.log(e);
            }
        }
    };
    grid.on("dgrid-select, dgrid-deselect", function(evt) {
        selectionCheck(evt.rows.length);
    });
    //grid.select(1);
    selectionCheck(0);

});
</script>
</div>
