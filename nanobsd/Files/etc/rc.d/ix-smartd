#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: ix-smartd
# REQUIRE: FILESYSTEMS
# BEFORE: smartd

. /etc/rc.subr

: ${smartd_config="/usr/local/etc/smartd.conf"}

generate_smartd_cfg()
{
    local IFS=\|
    local disk opts
    cat <<EOF
################################################
# smartd.conf generated by FreeNAS
################################################
EOF
    local mode diff info crit email
    ${FREENAS_SQLITE_CMD} ${FREENAS_CONFIG} "SELECT smart_powermode, smart_difference, smart_informal, smart_critical, smart_email FROM services_smart ORDER by -id LIMIT 1" | 
    while read mode diff info crit email; do

        ${FREENAS_SQLITE_CMD} ${FREENAS_CONFIG} "SELECT disk_identifier, disk_smartoptions FROM storage_disk WHERE disk_togglesmart=1" |
        while read ident opts; do
            disk=$(/usr/local/bin/python /usr/local/www/freenasUI/middleware/notifier.py identifier_to_device "${ident}")
            if [ "${disk}" = "None" ]; then
                continue
            fi
            echo -n "/dev/${disk} -d removable"
            echo -n " -n ${mode}"
            echo -n " -W ${diff},${info},${crit}"
            if [ -n "${email}" ]; then
                echo -n " -m ${email}"
            fi
            echo " $opts"
        done
    done
}

generate_smartd()
{
	echo "generate_smartd_cfg > ${smartd_config}"
	generate_smartd_cfg > ${smartd_config}
}

name=ix-smartd
start_cmd=generate_smartd
stop_cmd=':'

load_rc_config $name
run_rc_command "$1"
