#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: ix-smartd
# REQUIRE: FILESYSTEMS
# BEFORE: smartd

. /etc/rc.subr

: ${smartd_config="/usr/local/etc/smartd.conf"}

generate_smartd_cfg()
{
    local IFS=\|
    local disk opts
    cat <<EOF
################################################
# smartd.conf generated by FreeNAS
################################################
EOF
    ${FREENAS_SQLITE_CMD} ${FREENAS_CONFIG} "SELECT disk_name, disk_smartoptions FROM storage_disk WHERE disk_togglesmart=1" |
    while read disk opts; do
	echo "/dev/$disk $opts"
    done
}

generate_smartd()
{
	echo "generate_smartd_cfg > ${smartd_config}"
	generate_smartd_cfg > ${smartd_config}
}

name=ix-smartd
start_cmd=generate_smartd
stop_cmd=':'

load_rc_config $name
run_rc_command "$1"
